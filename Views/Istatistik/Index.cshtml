@model Dictionary<string, object>

@{
    ViewData["Title"] = "İstatistikler";
    var toplamUrun = (int)(Model["ToplamUrun"] ?? 0);
    var toplamListe = (int)(Model["ToplamListe"] ?? 0);
    var toplamKategori = (int)(Model["ToplamKategori"] ?? 0);
    var toplamFavori = (int)(Model["ToplamFavori"] ?? 0);
    var alinanUrun = (int)(Model["AlinanUrun"] ?? 0);
    var alinanUrunOrani = (double)(Model["AlinanUrunOrani"] ?? 0);
    var toplamTutar = (decimal)(Model["ToplamTutar"] ?? 0m);
    var ortalamaFiyat = (decimal)(Model["OrtalamaFiyat"] ?? 0m);
    var kategoriBazliUrunler = (IEnumerable<dynamic>)Model["KategoriBazliUrunler"];
    var listeBazliIstatistikler = (IEnumerable<dynamic>)(Model.ContainsKey("ListeBazliIstatistikler") ? Model["ListeBazliIstatistikler"] : new List<dynamic>());
    var sonEklenenler = (IEnumerable<dynamic>)(Model.ContainsKey("SonEklenenler") ? Model["SonEklenenler"] : new List<dynamic>());
}

<div class="container py-4">
    <div class="page-header">
        <div class="page-title-section">
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i>
                İstatistikler
            </h1>
            <p class="page-subtitle">Alışveriş alışkanlıklarınızı analiz edin</p>
        </div>
    </div>

    <!-- Genel İstatistikler -->
    <div class="stats-overview">
        <div class="stat-card stat-danger">
            <div class="stat-icon">
                <i class="fas fa-shopping-basket"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@toplamUrun</div>
                <div class="stat-label">Toplam Ürün</div>
            </div>
        </div>
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@toplamListe</div>
                <div class="stat-label">Alışveriş Listesi</div>
            </div>
        </div>
        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@alinanUrun</div>
                <div class="stat-label">Alınan Ürün</div>
            </div>
        </div>
        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-lira-sign"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@toplamTutar.ToString("F0") ₺</div>
                <div class="stat-label">Toplam Tutar</div>
            </div>
        </div>
        <div class="stat-card stat-secondary">
            <div class="stat-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@toplamKategori</div>
                <div class="stat-label">Kategori</div>
            </div>
        </div>
        <div class="stat-card stat-pink">
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@toplamFavori</div>
                <div class="stat-label">Favori Ürün</div>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-main">
            <!-- Kategori Dağılımı Grafiği ve Fiyat İstatistikleri -->
            @if (kategoriBazliUrunler.Any())
            {
                <div class="content-card">
                    <div class="card-header-wrapper">
                        <div class="card-title-group">
                            <i class="fas fa-chart-pie"></i>
                            <h2>Kategori Dağılımı</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="kategoriChart" style="max-height: 300px;"></canvas>
                            </div>
                            <div class="col-md-6">
                                <div class="lists-list">
                                    <div class="list-item">
                                        <div class="list-color" style="background-color: #00b894;"></div>
                                        <div class="list-info">
                                            <div class="list-name">Toplam Harcama</div>
                                            <div class="list-meta">@toplamTutar.ToString("F2") ₺</div>
                                        </div>
                                    </div>
                                    <div class="list-item">
                                        <div class="list-color" style="background-color: #fdcb6e;"></div>
                                        <div class="list-info">
                                            <div class="list-name">Ortalama Fiyat</div>
                                            <div class="list-meta">@ortalamaFiyat.ToString("F2") ₺</div>
                                        </div>
                                    </div>
                                    <div class="list-item">
                                        <div class="list-color" style="background-color: #6c5ce7;"></div>
                                        <div class="list-info">
                                            <div class="list-name">Alınan Tutar</div>
                                            @{
                                                var alinanTutar = toplamTutar * ((decimal)alinanUrunOrani / 100m);
                                            }
                                            <div class="list-meta">@alinanTutar.ToString("F2") ₺</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Liste Bazlı İstatistikler -->
            @if (listeBazliIstatistikler.Any())
            {
                <div class="content-card">
                    <div class="card-header-wrapper">
                        <div class="card-title-group">
                            <i class="fas fa-list"></i>
                            <h2>Liste Bazlı İstatistikler</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Liste Adı</th>
                                        <th>Toplam Ürün</th>
                                        <th>Alınan</th>
                                        <th>Tamamlanma</th>
                                        <th>Toplam Tutar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var liste in listeBazliIstatistikler)
                                    {
                                        var tamamlanma = liste.UrunSayisi > 0 ? ((double)liste.AlinanUrunSayisi / liste.UrunSayisi * 100) : 0;
                                        <tr>
                                            <td><strong>@liste.Ad</strong></td>
                                            <td>@liste.UrunSayisi</td>
                                            <td>@liste.AlinanUrunSayisi</td>
                                            <td>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar" style="width: @tamamlanma%"></div>
                                                </div>
                                                <small>@tamamlanma.ToString("F1")%</small>
                                            </td>
                                            <td>@(((decimal)liste.ToplamTutar).ToString("F2")) ₺</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="dashboard-sidebar">
            <!-- Son Eklenen Ürünler -->
            @if (sonEklenenler.Any())
            {
                <div class="content-card">
                    <div class="card-header-wrapper">
                        <div class="card-title-group">
                            <i class="fas fa-clock"></i>
                            <h2>Son Eklenenler</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="lists-list">
                            @foreach (var urun in sonEklenenler)
                            {
                                <div class="list-item">
                                    <div class="list-color" style="background-color: var(--primary-color);"></div>
                                    <div class="list-info">
                                        <div class="list-name">@urun.UrunAdi</div>
                                        <div class="list-meta">@(((DateTime)urun.EklenmeTarihi).ToString("dd.MM.yyyy HH:mm"))</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Kategori Dağılımı Grafiği
            const kategoriCtx = document.getElementById('kategoriChart');
            if (kategoriCtx) {
                const kategoriVerileri = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(kategoriBazliUrunler.Select(k => new { label = k.Ad, value = k.UrunSayisi })));
                const renkler = [
                    '#ff6b35', '#00b894', '#fdcb6e', '#6c5ce7', '#e17055',
                    '#74b9ff', '#a29bfe', '#fab1a0', '#81ecec', '#ffeaa7'
                ];

                new Chart(kategoriCtx, {
                    type: 'doughnut',
                    data: {
                        labels: kategoriVerileri.map(k => k.label),
                        datasets: [{
                            data: kategoriVerileri.map(k => k.value),
                            backgroundColor: renkler.slice(0, kategoriVerileri.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 12,
                                        family: "'Inter', sans-serif"
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
}
